---
template:
  - sensor:
      - unique_id: latest_location
        name: Latest Location
        state: |
          {% set current_location = states("sensor.latest_location") %}
          {% if trigger.from_state.state == "unknown" or new_locations == "unknown" %}
            unknown
          {% else %}
            {% set old_locations = trigger.from_state.state | from_json %}
            {% set new_locations = trigger.to_state.state | from_json %}
            {% if old_locations == new_locations + [current_location] %}
              {{ current_location }}
            {% else %}
              {{ new_locations | last }}
            {% endif %}
          {% endif %}
    trigger:
      - platform: state
        entity_id: sensor.latest_locations
  - sensor:
      - unique_id: latest_locations
        name: Latest Locations
        state: |
          {% set locations = states("sensor.latest_locations") %}
          {% set locations = [] if locations == "unknown" else locations | from_json %}
          {% if trigger_id == "idle" %}
            {% set locations = locations | last %}
          {% elif trigger_id == "reset" %}
            {% set locations = [] %}
          {% endif %}
          {% if trigger_id == "leave_home" %}
            {% set locations = [] %}
          {% endif %}
          {% if trigger_id == "return_home" %}
            {% set locations = ["living_room"] %}
          {% endif %}
          {% if trigger_id == "enter_kitchen" %}
            {% set locations = locations + ["living_room", "kitchen"] %}
          {% endif %}
          {% if trigger_id == "leave_kitchen" and "kitchen" in locations %}
            {% set _ = locations.pop(locations.index("kitchen")) %}
          {% endif %}
          {% if trigger_id == "enter_bathroom" %}
            {% set locations = locations + ["bathroom"] %}
          {% endif %}
          {% if trigger_id == "leave_bathroom" and "bathroom" in locations %}
            {% set _ = locations.pop(locations.index("bathroom")) %}
          {% endif %}
          {% if trigger_id == "desk_chair" %}
            {% set locations = locations + ["living_room", "desk_chair"] %}
          {% elif "desk_chair" in locations %}
            {% set _ = locations.pop(locations.index("desk_chair")) %}
          {% endif %}
          {% if trigger_id == "bedroom_button" %}
            {% if "living_room" in locations %}
              {% set _ = locations.pop(locations.index("living_room")) %}
            {% endif %}
            {% set locations = locations + ["bedroom"] %}
          {% elif "bedroom" in locations %}
            {% set _ = locations.pop(locations.index("bedroom")) %}
          {% endif %}
          {{ locations | reverse | unique | reverse | list | to_json }}
    trigger:
      - platform: template
        value_template: "{{ states('sensor.latest_locations') }}"
        for:
          minutes: 5
        variables:
          trigger_id: idle
      - variables:
          trigger_id: reset
        platform: state
        entity_id: sensor.latest_locations
        to: unknown
      - variables:
          trigger_id: reset
        platform: homeassistant
        event: start
      - variables:
          trigger_id: return_home
        platform: state
        entity_id: person.djhaggi
        to: home
      - variables:
          trigger_id: leave_home
        platform: state
        entity_id: person.djhanggi
        to: not_home
        for:
          seconds: 90
      - variables:
          trigger_id: enter_kitchen
        platform: state
        entity_id: binary_sensor.aqara_motion_kitchen
        to: "on"
      - variables:
          trigger_id: leave_kitchen
        platform: state
        entity_id: binary_sensor.aqara_motion_kitchen
        to: "off"
        for:
          seconds: 90
      - variables:
          trigger_id: enter_bathroom
        platform: state
        entity_id: binary_sensor.aqara_motion_bathroom
        to: "on"
      - variables:
          trigger_id: leave_bathroom
        platform: state
        entity_id: binary_sensor.aqara_motion_bathroom
        to: "off"
        for:
          seconds: 90
      - variables:
          trigger_id: desk_chair
        platform: state
        entity_id: binary_sensor.aqara_vibration_desk_chair
        to: "on"
      - platform: event
        event_type: deconz_event
        variables:
          trigger_id: |
            {% if trigger.event.data.id == "aqara_bedroom_switch" %}
              bedroom_button
            {% endif %}
